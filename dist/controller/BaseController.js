sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/UIComponent","../model/formatter"],function(e,t,a){"use strict";var o;return e.extend("requestmanagement.controller.BaseController",{formatter:a,getModelTQA:function(){return o},setModelTQA:function(e){var t=sessionStorage.getItem("oLangu");if(!t){t="EN"}var a=this.getModel().sServiceUrl+(this.getModel().sServiceUrl.includes("?")?"&":"?")+"sap-language="+t;o=new sap.ui.model.odata.v2.ODataModel({serviceUrl:a,annotationURI:"/zsrv_iwfnd/Annotations(TechnicalName='%2FTQA%2FOD_REQUEST_MANAGE_ANNO_MDL',Version='0001')/$value/",headers:{authorization:e,applicationName:"REQUEST_MANAGE"}});var s=new sap.ui.model.odata.v2.ODataModel({serviceUrl:"/sap/opu/odata/TQA/OD_VARIANTS_MANAGEMENT_SRV",headers:{authorization:e,applicationName:"REQUEST_MANAGE"}});this.setModel(s,"vModel");this.setModel(o)},getRouter:function(){return t.getRouterFor(this)},getModel:function(e){return this.getView().getModel(e)},setModel:function(e,t){return this.getView().setModel(e,t)},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},onNavigation:function(e,t,a){if(e){this.getRouter().navTo(t,{objectId:e.replace(a,"")})}else{this.getRouter().navTo(t,{})}},onObjectMatched:function(e){this.onBindView("/"+e.getParameter("config").pattern.replace("/{objectId}","")+e.getParameter("arguments").objectId,e.getParameter("arguments").bForceRefresh)},onNavBack:function(){sessionStorage.setItem("goToLaunchpad","X");this.onNavigation("","requests","")},onBindView:function(e,t){this.getView().bindElement({path:e,change:this.onBindingChange.bind(this),events:{dataRequested:function(){this.getModel("appView").setProperty("/busy",true)}.bind(this),dataReceived:function(){this.getModel("appView").setProperty("/busy",false);var t=this.getModel(),a=t.getObject(e),o=this.onAddRequestInfo(e,a.request_type);if(a.request_status_item=="0002"||a.request_status_item=="0000"||a.request_status_item=="0003"){sap.ui.getCore().byId("approveRequest").setProperty("visible",false);sap.ui.getCore().byId("rejectRequest").setProperty("visible",false);sap.ui.getCore().byId("approveRequest").setProperty("enabled",false);sap.ui.getCore().byId("rejectRequest").setProperty("enabled",false)}else{sap.ui.getCore().byId("approveRequest").setProperty("visible",true);sap.ui.getCore().byId("rejectRequest").setProperty("visible",true);sap.ui.getCore().byId("approveRequest").setProperty("enabled",true);sap.ui.getCore().byId("rejectRequest").setProperty("enabled",true)}if(!o){this.onNavigation("","requests","")}}.bind(this)}});if(t||!this.getView().getModel().getProperty("/"+e)){this.getView().getModel().refresh()}},onOpenDocument:function(e){var t=e.getSource().getBindingContext().getPath(),a=this.getModel().getObject(t).document;this._pdfViewer=new sap.m.PDFViewer;if(a!=""){var o=atob(a);if(o.indexOf(",")!=-1)o=o.substring(o.indexOf(",")+1,o.length);o=atob(o);var s=new Uint8Array(o.length);for(var i=0;i<o.length;i++){s[i]=o.charCodeAt(i)}var n=new Blob([s.buffer],{type:"application/pdf"}),r=URL.createObjectURL(n);this._PDFViewer=new sap.m.PDFViewer({width:"auto",showDownloadButton:false,source:r});jQuery.sap.addUrlWhitelist("blob");this._PDFViewer.open()}},onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("notFound");return}},buildDialogs:function(e,t,a){try{this.oDialog=new sap.m.Dialog({title:e.oTitle,id:e.oId,afterClose:this.onAfterClose.bind(this)});if(t.length>0){this.oDialog.addContent(this.oGrid=new sap.ui.layout.Grid({defaultSpan:"L12 M12 S12",width:"auto"}));this.oGrid.addContent(this.oSimpleForm=new sap.ui.layout.form.SimpleForm({id:e.oId+"SimpleForm",minWidth:1024,layout:e.oLayout,labelSpanL:3,labelSpanM:3,emptySpanL:4,emptySpanM:4,columnsL:2,columnsM:2,maxContainerCols:2,editable:false}));t.forEach(e=>{switch(e.oControl){case sap.m.Input:this.oSimpleForm.addContent(new sap.m.Label({text:e.oLabelText,required:e.oRequired}));this.oInput=new sap.m.Input({id:e.oId,name:e.oName,enabled:e.oEnabled});if(e.oSelectedKey!=""){this.oInput.setSelectedKey(e.oSelectedKey)}else if(e.oValue!=""){this.oInput.setValue(e.oValue)}this.oSimpleForm.addContent(this.oInput);break;case sap.m.Select:if(e.oItems!=""){this.oSimpleForm.addContent(new sap.m.Label({text:e.oLabelText,required:e.oRequired}));this.oSelect=new sap.m.Select({id:e.oId,name:e.oName,enabled:e.oEnabled,change:this.onSelectChange.bind(this),forceSelection:e.oForceSelection});this.oSelect.setModel(this.getModel());this.oSelect.bindAggregation("items",{path:e.oItems,template:new sap.ui.core.Item({key:e.oKey,text:e.oText})});if(e.oSelectedKey!=""){this.oSelect.setSelectedKey(e.oSelectedKey)}this.oSimpleForm.addContent(this.oSelect)}break;case sap.m.DatePicker:this.oSimpleForm.addContent(new sap.m.Label({text:e.oLabelText}));this.oDatePicker=new sap.m.DatePicker({id:e.oId,name:e.oName,value:e.oValue,valueFormat:e.oValueFormat,required:e.oRequired,enabled:e.oEnabled,displayFormat:e.oDisplayFormat,minDate:e.oMinDate});if(e.oValue1!=""){this.oDatePicker.setDateValue(e.oValue1)}this.oSimpleForm.addContent(this.oDatePicker);break;case sap.ui.unified.FileUploader:this.oSimpleForm.addContent(new sap.m.Label({text:e.oLabelText}));this.oFileUploader=new sap.ui.unified.FileUploader({id:e.oId,name:e.oName,enabled:e.oEnabled,width:"100%",tooltip:e.oTooltip});if(e.oValue1!=""){this.oFileUploader.setValue(e.oValue)}this.oSimpleForm.addContent(this.oFileUploader);break;case sap.m.TextArea:this.oSimpleForm.addContent(new sap.m.Label({text:e.oLabelText}));this.oTextArea=new sap.m.TextArea({id:e.oId,enabled:e.oEnabled,required:e.oRequired,name:e.oId});this.oSimpleForm.addContent(this.oTextArea);break}});if(a.length>0){a.forEach(e=>{this.oDialog.addButton(new sap.m.Button({id:e.oId,text:e.oText,type:e.oType,press:e.oEvent}))})}}this.oDialog.open()}catch(e){var o={oText:e.message,oTitle:this.getResourceBundle().getText("errorMessageBoxTitle")};this.showErrorMessage(o)}},onCloseDialog:function(){this.oDialog.close()},onAfterClose:function(){if(this.oDialog){this.oDialog.destroy();this.oDialog=null}},showErrorMessage:function(e){new sap.m.MessageBox.error(e.oText,{title:e.oTitle,actions:[sap.m.MessageBox.Action.OK],emphasizedAction:sap.m.MessageBox.Action.OK})},getFields:function(e,t,a){this.aFields=[];t.forEach(t=>{for(let s=0;s<e.length;s++){if(a=="Dialog"){var o=sap.ui.getCore().byId(t).getContent().filter(function(t){return t instanceof e[s]});o.forEach(e=>{var t={id:"",value:""};t.id=e.getName();try{t.value=e.getValue()}catch(a){t.value=e.getSelectedKey()}this.aFields.push(t)})}else{var o=this.byId(t).getContent().filter(function(t){return t instanceof e[s]});o.forEach(e=>{var t={id:"",value:""};t.id=e.getName();t.value=e.getValue();this.aFields.push(t)})}}});return this.aFields},checkEmptyFields:function(e,t,a){this.getFields(e,t,a);this.checked=true;if(this.aFields.length>0){this.aFields.forEach(e=>{if(a=="Dialog"){var t=sap.ui.getCore().byId(e.id)}else{var t=this.byId(e.id)}if(t){if(t.getProperty("enabled")){try{if(t.getValue()==""){t.setValueState("Error");this.checked=false}else{t.setValueState("None")}}catch(e){if(t.getSelectedKey()==""){t.setValueState("Error");this.checked=false}else{t.setValueState("None")}}}}});if(this.checked){return true}else{return false}}},onUpdate:function(e,t){try{if(e){var a=this.getModel(),o=this.getModel("appView");sap.ui.core.BusyIndicator.show();a.update(e,t,{success:function(){sap.ui.core.BusyIndicator.hide();a.refresh(true)},error:function(e){sap.ui.core.BusyIndicator.hide();var t=JSON.parse(e.responseText).error.message.value;sap.m.MessageBox.alert(t,{icon:"ERROR",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}});a.attachRequestSent(function(){o.setProperty("/busy",true)});a.attachRequestCompleted(function(){o.setProperty("/busy",false)});a.attachRequestFailed(function(){o.setProperty("/busy",false)})}}catch(e){var s={oText:e.message,oTitle:this.getResourceBundle().getText("errorMessageBoxTitle")};this.showErrorMessage(s)}},onAddRequestInfo:function(e,t){var a=this.getModel(),o=this.byId("generalInfoForm"),s=this.byId("documentationForm");if(t&&e){try{o.destroyContent();s.destroyContent();o.addContent(new sap.m.Label({text:this.getResourceBundle().getText("customer")}));o.addContent(new sap.m.Text({text:"{bp} ({BpNo})"}));o.addContent(new sap.m.Label({text:this.getResourceBundle().getText("person")}));o.addContent(new sap.m.Text({text:"{request_description}"}));o.addContent(new sap.m.Label({text:this.getResourceBundle().getText("request_type")}));o.addContent(new sap.m.Text({text:"{request_type_desc}"}));o.addContent(new sap.m.Label({text:this.getResourceBundle().getText("created_by")}));o.addContent(new sap.m.Text({text:"{created_by}"}));o.addContent(new sap.m.Label({text:this.getResourceBundle().getText("justification")}));o.addContent(new sap.m.Text({text:"{justification}"}));switch(t){case"0001":var i=new sap.m.Table({id:"UserDocumentationTable",width:"100%",busyIndicatorDelay:"{appView>/delay}"});var n=[new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("doc_no")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("doc_type")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("issue_date")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("exp_date")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("doc_status")})})];n.forEach(e=>{i.addColumn(e)});var r=new sap.m.ColumnListItem({type:sap.m.ListType.Navigation,press:this.onOpenDocument.bind(this)});var d=[new sap.m.ObjectIdentifier({text:"{document_no}"}),new sap.m.ObjectIdentifier({title:"{doc_type_desc}",text:"{doc_subty_desc}"}),new sap.m.ObjectIdentifier({text:{path:"issue_date",formatter:this.formatter.dateFormat.bind(this.formatter)}}),new sap.m.ObjectIdentifier({text:{path:"exp_date",formatter:this.formatter.dateFormat.bind(this.formatter)}}),new sap.m.ObjectStatus({text:"{doc_status_desc}",state:{path:"doc_status",formatter:function(e){if(e){switch(e){case"0001":return"Success";break;case"0002":return"Error";break;case"0003":return"Warning";break}}}}})];d.forEach(e=>{r.addCell(e)});i.bindAggregation("items",{path:"toUserRequest",template:r});s.addContent(i);break;case"0002":var i=new sap.m.Table({id:"EquiDocumentationTable",width:"100%",busyIndicatorDelay:"{appView>/delay}"});var n=[new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("equi_attach_type_desc")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("issue_date")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("exp_date")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("comments")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("doc_status")})})];n.forEach(e=>{i.addColumn(e)});var r=new sap.m.ColumnListItem({type:sap.m.ListType.Navigation,press:this.onOpenDocument.bind(this)});var d=[new sap.m.ObjectIdentifier({text:"{equi_attach_type_desc}"}),new sap.m.ObjectIdentifier({text:{path:"issue_date",formatter:this.formatter.dateFormat.bind(this.formatter)}}),new sap.m.ObjectIdentifier({text:{path:"expiration_date",formatter:this.formatter.dateFormat.bind(this.formatter)}}),new sap.m.ExpandableText({text:"{comments}"}),new sap.m.ObjectStatus({text:"{doc_status_desc}",state:{path:"doc_status",formatter:function(e){if(e){switch(e){case"0001":return"Warning";break;case"0002":return"Success";break;case"0003":return"Error";break}}}}})];d.forEach(e=>{r.addCell(e)});i.bindAggregation("items",{path:"toEquiRequest",template:r});s.addContent(i);break;case"0003":var i=new sap.m.Table({id:"BomItemsTable",width:"100%",busyIndicatorDelay:"{appView>/delay}"});var n=[new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("bom_no")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("item")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("component_no")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("material")})}),new sap.m.Column({header:new sap.m.Text({text:this.getResourceBundle().getText("quantity")})})];n.forEach(e=>{i.addColumn(e)});var r=new sap.m.ColumnListItem({});var d=[new sap.m.ObjectIdentifier({text:"{stlnr}"}),new sap.m.ObjectIdentifier({text:"{posnr}"}),new sap.m.ObjectIdentifier({text:"{idnrk}"}),new sap.m.ObjectIdentifier({text:"{maktx}"}),new sap.m.ObjectIdentifier({text:"{menge}"})];d.forEach(e=>{r.addCell(e)});i.bindAggregation("items",{path:"/items",template:r});var l=e+"/toBomRequest";a.read(l,{success:function(e){debugger;var t=new sap.ui.model.json.JSONModel;t.setData({items:JSON.parse(e.results[0].bom_items)});i.setModel(t);i.bindAggregation("items",{path:"/items",template:i.getBindingInfo("items").template})},error:function(e){var t=JSON.parse(e.responseText).error.message.value;sap.m.MessageBox.alert(t,{icon:"ERROR",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}});s.addContent(i);break}return true}catch(e){}}else{return false}},handleApproveRequest:function(e){var t="",a={RequestId:"00000000-0000-0000-0000-000000000000",BpNo:"0000000000"};if(e=="1"){t=this.getView().getBindingContext().getPath().replace("/xTQAxREQUESTS","/ApproveRequests");this.onUpdate(t,a);var o=this.getModel().getObject(this.getView().getBindingContext().getPath());if(o.request_status_item=="0002"){this.onNavigation("","requests","")}}else{t=sap.ui.getCore().byId("RequestTable").getTable().getSelectedContextPaths()[0].replace("/xTQAxREQUESTS","/ApproveRequests");sap.ui.getCore().byId("RequestTable").getTable().removeSelections();this._manageButtons(false,false);this.onUpdate(t,a)}},handleRejectRequest:function(e){this.oOperation=e;var t=[],a={oLabelText:this.getResourceBundle().getText("rejectLabel"),oId:"Justification",oRequired:true,oValue:"",oEnabled:true,oControl:sap.m.TextArea},o={oId:"oDialog",oLayout:"ResponsiveGridLayout",oTitle:this.getResourceBundle().getText("rejectRequest")},s=[],i={oId:"oCancelButton",oText:this.getResourceBundle().getText("closeDialog"),oType:"Default",oEvent:this.onCloseDialog.bind(this)},n={oId:"oConfirmButton",oText:this.getResourceBundle().getText("confirmButton"),oType:"Emphasized",oEvent:this.onRejectRequest.bind(this)};t.push(a);s.push(i,n);this.buildDialogs(o,t,s)},onRejectRequest:function(){var e=[],t=[];e.push(sap.m.TextArea);t.push("oDialogSimpleForm");var a=this.checkEmptyFields(e,t,"Dialog");if(a){var o="",s={RequestId:"",Justification:this.aFields.find(({id:e})=>e==="Justification").value};if(this.oOperation=="1"){s.RequestId=this.getView().getBindingContext().getPath().RequestId;o=this.getView().getBindingContext().getPath().replace("/xTQAxREQUESTS","/ReproveRequests")}else{s.RequestId=this.getModel().getObject(sap.ui.getCore().byId("RequestTable").getTable().getSelectedContextPaths()[0]).RequestId;o=sap.ui.getCore().byId("RequestTable").getTable().getSelectedContextPaths()[0].replace("/xTQAxREQUESTS","/ReproveRequests");sap.ui.getCore().byId("RequestTable").getTable().removeSelections();this._manageButtons(false,false)}this.onCloseDialog();this.onUpdate(o,s)}},getUserAuthentication:function(e){var t=this,a=new URLSearchParams(window.location.search),o=a.get("token");if(o!=null){var s=new Headers;s.append("X-authorization",o);var i={method:"GET",headers:s,redirect:"follow"};fetch("/sap/opu/odata/TQA/AUTHENTICATOR_SRV/USER_AUTHENTICATION",i).then(function(e){if(!e.ok){throw new Error("Ocorreu um erro ao ler a entidade.")}return e.text()}).then(function(e){var a=new DOMParser,s=a.parseFromString(e,"text/xml"),i=s.getElementsByTagName("d:SuccessResponse")[0],n=i.textContent;if(n!="X"){t.getRouter().navTo("NotFound")}else{t.getModel("appView").setProperty("/token",o)}}).catch(function(e){console.error(e)})}else{t.getRouter().navTo("NotFound");return}}})});
//# sourceMappingURL=BaseController.js.map