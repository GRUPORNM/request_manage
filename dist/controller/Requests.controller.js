sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel"],function(e,t){"use strict";return e.extend("requestmanagement.controller.Drivers",{onInit:function(){var e=new t({busy:false,delay:0,oStandard:"bp,request_description,request_type_desc,request_status,created_on,created_by,justification",oSmartTableView:"",variantInput:"Standard"});sessionStorage.setItem("goToLaunchpad","X");this.setModel(e,"Main");this.getRouter().attachRouteMatched(this.getUserAuthentication,this)},onSelectionChange:function(e){var t=e.getSource(),a=t.getSelectedContextPaths()[0],i=this.getModel().getObject(a);if(i.RequestStatusCriticality){switch(i.RequestStatusCriticality){case 1:this._manageButtons(false,false);break;case 2:this._manageButtons(true,true);break;case 3:this._manageButtons(false,false);break}}else{this._manageButtons(false,false);t.removeSelections()}},_manageButtons:function(e,t){sap.ui.getCore().byId("approveRequest").setEnabled(e);sap.ui.getCore().byId("rejectRequest").setEnabled(t)},onPressDriverDetail:function(e){sessionStorage.setItem("goToLaunchpad","");this.onNavigation(e.getSource().getBindingContext().getPath(),"request","/xTQAxREQUESTS")},onAfterRendering:function(){sessionStorage.setItem("goToLaunchpad","X");if(sessionStorage.getItem("selectedTheme").indexOf("dark")!==-1){this.byId("variantInput").removeStyleClass("variantMode");this.byId("variantInput").addStyleClass("variantModeBlack");jQuery(".sapUiBlockLayer, .sapUiLocalBusyIndicator").css("background-color","rgba(28,34,40,0.99)")}else{this.byId("variantInput").removeStyleClass("variantModeBlack");this.byId("variantInput").addStyleClass("variantMode");jQuery(".sapUiBlockLayer, .sapUiLocalBusyIndicator").css("background-color","rgba(255, 255, 255, 0.99)")}},onBeforeRendering:function(){this.onStartVariants()},onStartVariants:function(){var e=this,t=this.getModel("vModel");t.read("/xTQAxUSR_VARIANTS_DD",{success:function(t){var a=t.results;a.forEach(t=>{if(t.v_default){e.getModel("Main").setProperty("/variantInput",t.v_name);e.getModel("Main").setProperty("/selectedVariant",t.variant_id);if(t.variant_id!="Main"){var a=JSON.parse(atob(t.fbar_settings));e.onUpdateFilterBar(a);var i=JSON.parse(atob(t.stable_settings));var n=i.map(function(e){return e.name}).join(",");if(n.endsWith(",")){n=n.substring(0,n.length-1)}e.getModel("Main").setProperty("/oSmartTableView",n);e.onBuildSmartTable()}else{e.getModel("Main").setProperty("/oSmartTableView",e.getModel("Main").getProperty("/oStandard"));e.onBuildSmartTable()}}})},error:function(e){}})},onBuildSmartTable:function(){var e=sap.ui.getCore().byId("RequestTable");if(e){e.destroy()}var t=sap.ui.getCore().byId("RequestTable");if(!t){var a=this.getView(),i=this.getModel("Main");var n=new sap.m.OverflowToolbar({design:"Transparent"});var s=new sap.m.ToolbarSpacer;var r=new sap.m.Button({id:"approveRequest",text:"{i18n>approveButton}",enabled:false,press:this.handleApproveRequest.bind(this)});var o=new sap.m.Button({id:"rejectRequest",text:"{i18n>rejectButton}",enabled:false,press:this.handleRejectRequest.bind(this)});n.addContent(s);n.addContent(r);n.addContent(o);var l=new sap.ui.comp.smarttable.SmartTable({id:"RequestTable",entitySet:"xTQAxREQUESTS",smartFilterId:"smartFilterBarGroups",tableType:"ResponsiveTable",header:"{i18n>RequestsTableTitle}",showRowCount:true,customToolbar:n,enableAutoBinding:true,initialise:function(){this.onSTinitialise.bind(this);var e=false,t=l.getTable();t.setMode("SingleSelectLeft");t.attachSelectionChange(this.onSelectionChange.bind(this));t.attachUpdateFinished(function(){var a=t.getItems();if(a.length>0){a.forEach(e=>{if(e instanceof sap.m.ColumnListItem){e.setType("Navigation");e.attachPress(this.onPressDriverDetail.bind(this))}})}if(!e){this.applySorting(t);e=true}}.bind(this))}.bind(this),beforeRebindTable:this.onBeforeRebindTable.bind(this),initiallyVisibleFields:i.getProperty("/oSmartTableView")}).addStyleClass("sapUiSmallMarginTop");var d=a.byId("page");d.setContent(l);var u=new sap.m.OverflowToolbar({});l.setCustomToolbar(u)}},applySorting:function(e){var t=e.getBinding("items");if(t){var a=new sap.ui.model.Sorter("request_type_desc",false,true);t.sort(a)}},onRouteMatched:function(){this.getUserAuthentication()},onFBarInitialise:function(e){var t=this.byId("smartFilterBarGroups").getFilterGroupItems(),a=[];t.forEach(function(e){if(e.mProperties.visibleInFilterBar){var t={name:e.mProperties.name,visibleInFilterBar:e.mProperties.visibleInFilterBar};a.push(t)}});this.getModel("Main").setProperty("/vStandard",a)},onSTinitialise:function(e){var t=this,a=e.getSource(),i=a.getTable(),n=[],s=i.getColumns();s.forEach(function(e){var t=e.sId.lastIndexOf("-");if(t!==-1){var a=e.sId.substring(t+1)}n.push({name:a})});t.getModel("Main").setProperty("/vSmartTableStandard",n)},onBeforeRebindTable:function(e){var t=this,a=e.getSource(),i=a.getTable(),n=[],s=i.getColumns();s.forEach(function(e){var t=e.sId.lastIndexOf("-");if(t!==-1){var a=e.sId.substring(t+1)}if(e.getVisible())n.push({name:a})});var r=this.checkArrayDifference(this.getModel("Main").getProperty("/oSmartTableView"),n);if(r){var o=this.byId("variantInput"),l=JSON.stringify(n),d=btoa(l);this.getModel("Main").setProperty("/SmartTableBtoa",d)}},checkArrayDifference:function(e,t){if(e.length!==t.length){return false}var a=e.slice().sort(),i=t.slice().sort();for(var n=0;n<a.length;n++){if(a[n]!==i[n]){return false}}return true},onUpdateFilterBar:function(e){var t=this.byId("smartFilterBarGroups").getFilterGroupItems();this.byId("smartFilterBarGroups").clear();t.forEach(e=>{e.setVisibleInFilterBar(false)});e.forEach(function(e){t.forEach(function(t){if(e.name===t.getName()){t.setVisibleInFilterBar(true);var a=t.getControl();var i=e.aFilters;if(i&&i.length>0){var n=i[0];if(a instanceof sap.m.Input||a instanceof sap.m.MultiInput){a.setValue("*"+n.oValue1+"*")}else if(a instanceof sap.m.Select||a instanceof sap.m.ComboBox){a.setSelectedKey(n.oValue1)}else if(a instanceof sap.m.CheckBox){a.setSelected(n.oValue1==="true"||n.oValue1===true)}}}})})},onShowVariantList:function(e){var t=this,a=this.getModel("vModel");if(!this._oPopover){var i=new sap.m.List;i.setModel(a);i.bindItems({path:"/xTQAxUSR_VARIANTS_DD",template:new sap.m.StandardListItem({title:"{v_name}"})});i.setMode(sap.m.ListMode.SingleSelectMaster);i.attachUpdateFinished(function(){this.getItems().forEach(function(e){e.removeStyleClass("sapMSelectListItemBaseSelected")});this.getItems().forEach(function(e){var a=e.getBindingContext();var i=a.getProperty("variant_id");var n=t.getModel("Main").getProperty("/selectedVariant");if(!n){if(i==="Main"){e.addStyleClass("sapMSelectListItemBaseSelected")}}else{if(i===n){e.addStyleClass("sapMSelectListItemBaseSelected");t.byId("variantInput").setValue(a.getProperty("v_name"))}}})});i.attachSelectionChange(function(e){this.getItems().forEach(function(e){e.removeStyleClass("sapMSelectListItemBaseSelected")});var a=e.getParameter("listItem");a.addStyleClass("sapMSelectListItemBaseSelected");var i=a.getBindingContext();var n=i.getProperty("variant_id");t.getModel("Main").setProperty("/selectedVariant",n);t.byId("variantInput").setValue(i.getProperty("v_name"));if(n!="Main"){var s=t.getModel("vModel").getObject(i.sPath),r=atob(s.fbar_settings),o=JSON.parse(r);t.onUpdateFilterBar(o);var l=JSON.parse(atob(s.stable_settings));var d=l.map(function(e){return e.name}).join(",");if(d.endsWith(",")){d=d.substring(0,d.length-1)}t.getModel("Main").setProperty("/oSmartTableView",d);t.onBuildSmartTable()}else{t.onUpdateFilterBar(t.getModel("Main").getProperty("/vStandard"));t.getModel("Main").setProperty("/oSmartTableView",t.getModel("Main").getProperty("/oStandard"));t.onBuildSmartTable()}t._oPopover.close()});this._oPopover=new sap.m.ResponsivePopover({contentWidth:"25%",title:this.getView().getModel("i18n").getResourceBundle().getText("MyViews"),placement:"Bottom",beginButton:new sap.m.Button({text:this.getView().getModel("i18n").getResourceBundle().getText("SaveAs"),type:"Emphasized",press:function(){t.onBeforeSaveVariant();this._oPopover.close()}.bind(this)}),endButton:new sap.m.Button({text:this.getView().getModel("i18n").getResourceBundle().getText("Manage"),press:function(){t.onManageViews();this._oPopover.close()}.bind(this)}),content:[i]})}this._oPopover.openBy(e.getSource())},onManageViews:function(){if(!this._oManageDialog){var e=this.getModel("vModel");var t=new sap.m.SearchField({width:"100%",placeholder:this.getView().getModel("i18n").getResourceBundle().getText("Search"),liveChange:function(e){var t=e.oSource.getValue();var i=new sap.ui.model.Filter("v_name",sap.ui.model.FilterOperator.Contains,t);a.getBinding("items").filter([i])}});var a=new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:this.getView().getModel("i18n").getResourceBundle().getText("VariantName")})}),new sap.m.Column({header:new sap.m.Label({text:this.getView().getModel("i18n").getResourceBundle().getText("Default")})}),new sap.m.Column({header:new sap.m.Label({text:this.getView().getModel("i18n").getResourceBundle().getText("CreatedAt")})}),new sap.m.Column({header:new sap.m.Label({text:""})})]});a.setModel(e);a.bindItems({path:"/xTQAxUSR_VARIANTS_DD",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{v_name}"}),new sap.m.CheckBox({enabled:{path:"variant_id",formatter:function(e){if(e=="Main")return false}},selected:"{v_default}",select:function(t){var a=t.getSource();var i=a.getBindingContext();var n=a.getSelected();var s={};s.v_default=n;e.update(i.sPath,s,{success:function(t){e.refresh(true)},error:function(e){}})}}),new sap.m.Text({text:{path:"created_at",type:new sap.ui.model.type.Date({pattern:"dd-MM-yyyy"})}}),new sap.m.Button({icon:"sap-icon://decline",visible:{path:"v_name",formatter:function(e){if(e=="Standard"){return false}}},press:function(t){var a=t.getSource();var i=a.getBindingContext();e.remove(i.sPath,{success:function(e){},error:function(e){}})}})]})});this._oManageDialog=new sap.m.Dialog({title:this.getView().getModel("i18n").getResourceBundle().getText("Manageviews"),content:[t,a],beginButton:new sap.m.Button({text:this.getView().getModel("i18n").getResourceBundle().getText("Close"),press:function(){this._oManageDialog.close()}.bind(this)})})}this._oManageDialog.open()},onBeforeSaveVariant:function(){var e=this;var t=new sap.m.Input({id:"inVariantName"});var a=new sap.m.CheckBox({text:this.getView().getModel("i18n").getResourceBundle().getText("SetDefault")});var i=new sap.m.Dialog({title:this.getView().getModel("i18n").getResourceBundle().getText("SaveView"),content:[new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",content:[new sap.m.Label({text:this.getView().getModel("i18n").getResourceBundle().getText("View")}),t,a]})],buttons:[new sap.m.Button({text:this.getView().getModel("i18n").getResourceBundle().getText("Save"),type:"Emphasized",press:function(){e.onSaveVariant(t.getValue(),a.getSelected());i.destroy()}}),new sap.m.Button({text:this.getView().getModel("i18n").getResourceBundle().getText("Close"),press:function(){i.close();i.destroy()}})]});i.open()},onSaveVariant:function(e,t){var a=this,i=this.getModel("vModel"),n={},s=[],r=this.byId("smartFilterBarGroups"),o=r.getFilterGroupItems(),l=[];o.forEach(function(e){if(e.mProperties.visibleInFilterBar){var t={name:e.mProperties.name,visibleInFilterBar:e.mProperties.visibleInFilterBar};l.push(t)}});var d=JSON.stringify(l),u=btoa(d);this.getModel("Main").setProperty("/fbarBtoa",u);var g=JSON.parse(atob(this.getModel("Main").getProperty("/fbarBtoa")));r.getFilters().forEach(e=>{var t=e.aFilters;var a=g.find(e=>e.name===t[0]?.sPath);if(a){a.aFilters=t.length>0?t:" "}});n.v_name=e;if(this.getModel("Main").getProperty("/fbarBtoa"))n.fbar_settings=btoa(JSON.stringify(g));else n.fbar_settings=btoa(JSON.stringify(this.getModel("Main").getProperty("/vStandard")));if(this.getModel("Main").getProperty("/SmartTableBtoa")){n.stable_settings=this.getModel("Main").getProperty("/SmartTableBtoa")}else{var c=sap.ui.getCore().byId("RequestTable").getTable(),p=[],f=c.getColumns();f.forEach(function(e){var t=e.sId.lastIndexOf("-");if(t!==-1){var a=e.sId.substring(t+1)}if(e.getVisible())p.push({name:a})});n.stable_settings=btoa(JSON.stringify(p))}n.app_link="REQUEST_MANAGE";n.v_default=t;i.create("/xTQAxUSR_VARIANTS_DD",n,{success:function(e){a.getModel("Main").setProperty("/selectedVariant",e.variant_id)},error:function(e){}})},onFilterChange:function(e){var t=e.oSource.getFilterGroupItems(),a=[];t.forEach(function(e){if(e.mProperties.visibleInFilterBar){var t={name:e.mProperties.name,visibleInFilterBar:e.mProperties.visibleInFilterBar};a.push(t)}});var i=JSON.stringify(a),n=btoa(i);this.getModel("Main").setProperty("/fbarBtoa",n)}})});
//# sourceMappingURL=Requests.controller.js.map